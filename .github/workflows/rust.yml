name: Rust

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:

  build:
    runs-on: ubuntu-latest
    container: rust:1.59
    steps:
    - uses: actions/checkout@v2
    - uses: Swatinem/rust-cache@v1
    - name: Build
      run: cargo build --verbose
    - name: Build release
      run: cargo build --release --verbose

  test:
    runs-on: ubuntu-latest
    container: rust:1.59
    env:
      GRCOV: https://github.com/mozilla/grcov/releases/download/v0.8.7/grcov-x86_64-unknown-linux-gnu.tar.bz2
      COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
      PROJECT_NAME: "typed_dialogflow"
      RUSTC_BOOTSTRAP: 1 # fake nightly
      CARGO_INCREMENTAL: 0
      RUSTFLAGS: "-Zprofile -Ccodegen-units=1 -Copt-level=0 -Clink-dead-code -Coverflow-checks=off -Zpanic_abort_tests -Cpanic=abort"
      RUSTDOCFLAGS: "-Cpanic=abort"
    steps:
    - uses: actions/checkout@v2
    - name: Install grcov
      run: |
        wget $GRCOV
        tar -xf grcov*.tar.bz2 --directory /bin/
    - name: Run tests
      run: |
        cargo build --verbose
        cargo test --verbose
        grcov . -s . --binary-path ./target/debug/ -t lcov --branch --ignore-not-existing -o ./target/debug/coverage/
        ls ./target/debug/coverage/
    - name: Upload coverage
      uses: coverallsapp/github-action@1.1.3
      with:
        flag-name: "Unit"
        github-token: ${{ secrets.GITHUB_TOKEN }}
        path-to-lcov: "./target/debug/coverage/*lcov*"
